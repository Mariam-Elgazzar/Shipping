<div class="merchant-container">
  <div class="merchant-header">
    <h1>
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="16" y1="2" x2="16" y2="6"></line>
        <line x1="8" y1="2" x2="8" y2="6"></line>
        <line x1="3" y1="10" x2="21" y2="10"></line>
      </svg>
      Merchant Management
    </h1>
  </div>

  <div class="merchant-content">
    <div class="merchant-form-card">
      <div class="card-header">
        <h2>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="16" x2="12" y2="12"></line>
            <line x1="12" y1="8" x2="12" y2="8"></line>
          </svg>
          @if (isEditing()) { Edit Merchant } @else { New Merchant }
        </h2>
      </div>

      <div class="card-body">
        @if (errorMessage()) {
        <div class="error-message">{{ errorMessage() }}</div>
        }

        <form [formGroup]="merchantForm" (ngSubmit)="onSubmit()">
          <div class="form-row">
            <div class="form-group col-md-6">
              <label for="name">Name</label>
              <input
                type="text"
                id="name"
                formControlName="name"
                class="form-control"
                placeholder="Enter merchant name"
                [class.is-invalid]="
                  merchantForm.get('name')?.invalid &&
                  merchantForm.get('name')?.touched
                "
              />
              @if (merchantForm.get('name')?.invalid &&
              merchantForm.get('name')?.touched) {
              <div class="invalid-feedback">
                @if (merchantForm.get('name')?.errors?.['required']) {
                <span>Name is required</span>
                } @if (merchantForm.get('name')?.errors?.['minlength']) {
                <span>Name must be at least 3 characters</span>
                }
              </div>
              }
            </div>

            <div class="form-group col-md-6">
              <label for="email">Email</label>
              <input
                type="email"
                id="email"
                formControlName="email"
                class="form-control"
                placeholder="Enter email address"
                [class.is-invalid]="
                  merchantForm.get('email')?.invalid &&
                  merchantForm.get('email')?.touched
                "
              />
              @if (merchantForm.get('email')?.invalid &&
              merchantForm.get('email')?.touched) {
              <div class="invalid-feedback">
                @if (merchantForm.get('email')?.errors?.['required']) {
                <span>Email is required</span>
                } @if (merchantForm.get('email')?.errors?.['email']) {
                <span>Please enter a valid email</span>
                }
              </div>
              }
            </div>
          </div>

          <div class="form-row">
            <div class="form-group col-md-6">
              <label for="phoneNumber">Phone Number</label>
              <input
                type="tel"
                id="phoneNumber"
                formControlName="phoneNumber"
                class="form-control"
                placeholder="Enter phone number (e.g., +1234567890)"
                [class.is-invalid]="
                  merchantForm.get('phoneNumber')?.invalid &&
                  merchantForm.get('phoneNumber')?.touched
                "
              />
              @if (merchantForm.get('phoneNumber')?.invalid &&
              merchantForm.get('phoneNumber')?.touched) {
              <div class="invalid-feedback">
                @if (merchantForm.get('phoneNumber')?.errors?.['required']) {
                <span>Phone number is required</span>
                } @if (merchantForm.get('phoneNumber')?.errors?.['pattern']) {
                <span>Please enter a valid phone number</span>
                }
              </div>
              }
            </div>

            <div class="form-group col-md-6">
              <label for="storeName">Store Name</label>
              <input
                type="text"
                id="storeName"
                formControlName="storeName"
                class="form-control"
                placeholder="Enter store name"
                [class.is-invalid]="
                  merchantForm.get('storeName')?.invalid &&
                  merchantForm.get('storeName')?.touched
                "
              />
              @if (merchantForm.get('storeName')?.invalid &&
              merchantForm.get('storeName')?.touched) {
              <div class="invalid-feedback">Store name is required</div>
              }
            </div>
          </div>

          <div class="form-row">
            <div class="form-group col-md-6">
              <label for="rejectedOrderPercentage"
                >Rejected Order Percentage (%)</label
              >
              <input
                type="number"
                id="rejectedOrderPercentage"
                formControlName="rejectedOrderPercentage"
                class="form-control"
                placeholder="0"
                min="0"
                max="100"
                [class.is-invalid]="
                  merchantForm.get('rejectedOrderPercentage')?.invalid &&
                  merchantForm.get('rejectedOrderPercentage')?.touched
                "
              />
              @if (merchantForm.get('rejectedOrderPercentage')?.invalid &&
              merchantForm.get('rejectedOrderPercentage')?.touched) {
              <div class="invalid-feedback">
                @if
                (merchantForm.get('rejectedOrderPercentage')?.errors?.['required'])
                {
                <span>Percentage is required</span>
                } @if
                (merchantForm.get('rejectedOrderPercentage')?.errors?.['min'] ||
                merchantForm.get('rejectedOrderPercentage')?.errors?.['max']) {
                <span>Must be between 0 and 100</span>
                }
              </div>
              }
            </div>

            <div class="form-group col-md-6">
              <label for="specialPickUp">Special Pickup Fee ($)</label>
              <input
                type="number"
                id="specialPickUp"
                formControlName="specialPickUp"
                class="form-control"
                placeholder="0"
                min="0"
                [class.is-invalid]="
                  merchantForm.get('specialPickUp')?.invalid &&
                  merchantForm.get('specialPickUp')?.touched
                "
              />
              @if (merchantForm.get('specialPickUp')?.invalid &&
              merchantForm.get('specialPickUp')?.touched) {
              <div class="invalid-feedback">
                @if (merchantForm.get('specialPickUp')?.errors?.['required']) {
                <span>Special pickup fee is required</span>
                } @if (merchantForm.get('specialPickUp')?.errors?.['min']) {
                <span>Must be 0 or greater</span>
                }
              </div>
              }
            </div>
          </div>

          <div class="form-group">
            <label for="cityIds">Cities</label>
            <select
              id="cityIds"
              formControlName="cityIds"
              class="form-control"
              multiple
              [class.is-invalid]="
                merchantForm.get('cityIds')?.invalid &&
                merchantForm.get('cityIds')?.touched
              "
            >
              @for (city of cities(); track city.id) {
              <option [value]="city.id">{{ city.name }}</option>
              }
            </select>
            @if (merchantForm.get('cityIds')?.invalid &&
            merchantForm.get('cityIds')?.touched) {
            <div class="invalid-feedback">At least one city is required</div>
            }
          </div>

          <div class="form-group">
            <label>Special Prices</label>
            <div class="special-prices">
              @for (price of specialPrices.controls; track $index) {
              <div class="special-price-row" [formGroup]="price">
                <div class="form-row">
                  <div class="form-group col-md-6">
                    <select
                      formControlName="cityId"
                      class="form-control"
                      [class.is-invalid]="
                        price.get('cityId')?.invalid &&
                        price.get('cityId')?.touched
                      "
                    >
                      <option value="">Select City</option>
                      @for (city of cities(); track city.id) {
                      <option [value]="city.id">{{ city.name }}</option>
                      }
                    </select>
                    @if (price.get('cityId')?.invalid &&
                    price.get('cityId')?.touched) {
                    <div class="invalid-feedback">City is required</div>
                    }
                  </div>
                  <div class="form-group col-md-4">
                    <input
                      type="number"
                      formControlName="specialPrice"
                      class="form-control"
                      placeholder="0"
                      min="0"
                      [class.is-invalid]="
                        price.get('specialPrice')?.invalid &&
                        price.get('specialPrice')?.touched
                      "
                    />
                    @if (price.get('specialPrice')?.invalid &&
                    price.get('specialPrice')?.touched) {
                    <div class="invalid-feedback">
                      @if (price.get('specialPrice')?.errors?.['required']) {
                      <span>Price is required</span>
                      } @if (price.get('specialPrice')?.errors?.['min']) {
                      <span>Must be 0 or greater</span>
                      }
                    </div>
                    }
                  </div>
                  <div class="form-group col-md-2">
                    <button
                      type="button"
                      class="btn btn-icon btn-danger"
                      (click)="removeSpecialPrice($index)"
                      [disabled]="specialPrices.length === 1"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      >
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
              }
              <button
                type="button"
                class="btn btn-outline"
                (click)="addSpecialPrice()"
              >
                Add Special Price
              </button>
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-outline" (click)="cancel()">
              Cancel
            </button>
            <button
              type="submit"
              class="btn btn-primary"
              [disabled]="merchantForm.invalid || isLoading()"
            >
              @if (isEditing()) { Update } @else { Create }
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  @if (isLoading()) {
  <div class="loading">
    <mat-spinner diameter="40"></mat-spinner>
  </div>
  }
</div>
