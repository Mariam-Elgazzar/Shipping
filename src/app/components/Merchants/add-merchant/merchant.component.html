<div class="merchant-container">
  <div class="merchant-header">
    <h1>
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="16" y1="2" x2="16" y2="6"></line>
        <line x1="8" y1="2" x2="8" y2="6"></line>
        <line x1="3" y1="10" x2="21" y2="10"></line>
      </svg>
      Merchant Management
    </h1>
  </div>

  <div class="merchant-content">
    <div class="merchant-form-card">
      <div class="card-header">
        <h2>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="16" x2="12" y2="12"></line>
            <line x1="12" y1="8" x2="12" y2="8"></line>
          </svg>
          @if (isEditing()) { Edit Merchant } @else { New Merchant }
        </h2>
      </div>

      <div class="card-body">
        @if (errorMessage()) {
        <div class="error-message">
          {{ errorMessage() }}
          @if (errorMessage() === 'Failed to load Branches. Please try again.')
          {
          <button class="btn btn-retry" (click)="retryLoadBranches()">
            Retry
          </button>
          }
        </div>
        }

        <form [formGroup]="merchantForm" (ngSubmit)="onSubmit()">
          <div class="form-row">
            <div class="form-group col-md-6">
              <label for="name">Name <span class="required">*</span></label>
              <input
                type="text"
                id="name"
                formControlName="name"
                class="form-control"
                placeholder="Enter merchant name"
                [class.is-invalid]="
                  merchantForm.get('name')?.invalid &&
                  merchantForm.get('name')?.touched
                "
              />
              @if (merchantForm.get('name')?.invalid &&
              merchantForm.get('name')?.touched) {
              <div class="invalid-feedback">
                @if (merchantForm.get('name')?.errors?.['required']) {
                <span>Name is required</span>
                } @if (merchantForm.get('name')?.errors?.['minlength']) {
                <span>Name must be at least 3 characters</span>
                }
              </div>
              }
            </div>

            <div class="form-group col-md-6">
              <label for="userName"
                >Username <span class="required">*</span></label
              >
              <input
                type="text"
                id="userName"
                formControlName="userName"
                class="form-control"
                placeholder="Enter username"
                [class.is-invalid]="
                  merchantForm.get('userName')?.invalid &&
                  merchantForm.get('userName')?.touched
                "
              />
              @if (merchantForm.get('userName')?.invalid &&
              merchantForm.get('userName')?.touched) {
              <div class="invalid-feedback">
                @if (merchantForm.get('userName')?.errors?.['required']) {
                <span>Username is required</span>
                } @if (merchantForm.get('userName')?.errors?.['minlength']) {
                <span>Username must be at least 3 characters</span>
                }
              </div>
              }
            </div>
          </div>

          <div class="form-row">
            <div class="form-group col-md-6">
              <label for="email">Email <span class="required">*</span></label>
              <input
                type="email"
                id="email"
                formControlName="email"
                class="form-control"
                placeholder="Enter email address"
                [class.is-invalid]="
                  merchantForm.get('email')?.invalid &&
                  merchantForm.get('email')?.touched
                "
              />
              @if (merchantForm.get('email')?.invalid &&
              merchantForm.get('email')?.touched) {
              <div class="invalid-feedback">
                @if (merchantForm.get('email')?.errors?.['required']) {
                <span>Email is required</span>
                } @if (merchantForm.get('email')?.errors?.['email']) {
                <span>Please enter a valid email</span>
                }
              </div>
              }
            </div>

            <div class="form-group col-md-6">
              <label for="phoneNumber"
                >Phone Number <span class="required">*</span></label
              >
              <input
                type="tel"
                id="phoneNumber"
                formControlName="phoneNumber"
                class="form-control"
                placeholder="Enter phone number (e.g., +1234567890)"
                [class.is-invalid]="
                  merchantForm.get('phoneNumber')?.invalid &&
                  merchantForm.get('phoneNumber')?.touched
                "
              />
              @if (merchantForm.get('phoneNumber')?.invalid &&
              merchantForm.get('phoneNumber')?.touched) {
              <div class="invalid-feedback">
                @if (merchantForm.get('phoneNumber')?.errors?.['required']) {
                <span>Phone number is required</span>
                } @if (merchantForm.get('phoneNumber')?.errors?.['pattern']) {
                <span>Please enter a valid phone number (10-15 digits)</span>
                }
              </div>
              }
            </div>
          </div>

          <div class="form-row">
            <div class="form-group col-md-6">
              <label for="address"
                >Address <span class="required">*</span></label
              >
              <input
                type="text"
                id="address"
                formControlName="address"
                class="form-control"
                placeholder="Enter address"
                [class.is-invalid]="
                  merchantForm.get('address')?.invalid &&
                  merchantForm.get('address')?.touched
                "
              />
              @if (merchantForm.get('address')?.invalid &&
              merchantForm.get('address')?.touched) {
              <div class="invalid-feedback">
                @if (merchantForm.get('address')?.errors?.['required']) {
                <span>Address is required</span>
                } @if (merchantForm.get('address')?.errors?.['minlength']) {
                <span>Address must be at least 3 characters</span>
                }
              </div>
              }
            </div>

            <div class="form-group col-md-6">
              <label for="startWorkDDate"
                >Start Work Date <span class="required">*</span></label
              >
              <input
                type="datetime-local"
                id="startWorkDDate"
                formControlName="startWorkDDate"
                class="form-control"
                [class.is-invalid]="
                  merchantForm.get('startWorkDDate')?.invalid &&
                  merchantForm.get('startWorkDDate')?.touched
                "
              />
              @if (merchantForm.get('startWorkDDate')?.invalid &&
              merchantForm.get('startWorkDDate')?.touched) {
              <div class="invalid-feedback">
                @if (merchantForm.get('startWorkDDate')?.errors?.['required']) {
                <span>Start work date is required</span>
                }
              </div>
              }
            </div>
          </div>

          <div class="form-row">
            <div class="form-group col-md-6">
              <label for="password"
                >Password <span class="required">*</span></label
              >
              <input
                type="password"
                id="password"
                formControlName="password"
                class="form-control"
                placeholder="Enter password"
                [class.is-invalid]="
                  merchantForm.get('password')?.invalid &&
                  merchantForm.get('password')?.touched
                "
              />
              @if (merchantForm.get('password')?.invalid &&
              merchantForm.get('password')?.touched) {
              <div class="invalid-feedback">
                @if (merchantForm.get('password')?.errors?.['required']) {
                <span>Password is required</span>
                } @if (merchantForm.get('password')?.errors?.['minlength']) {
                <span>Password must be at least 6 characters</span>
                }
              </div>
              }
            </div>

            <div class="form-group col-md-6">
              <label for="storeName"
                >Store Name <span class="required">*</span></label
              >
              <input
                type="text"
                id="storeName"
                formControlName="storeName"
                class="form-control"
                placeholder="Enter store name"
                [class.is-invalid]="
                  merchantForm.get('storeName')?.invalid &&
                  merchantForm.get('storeName')?.touched
                "
              />
              @if (merchantForm.get('storeName')?.invalid &&
              merchantForm.get('storeName')?.touched) {
              <div class="invalid-feedback">Store name is required</div>
              }
            </div>
          </div>

          <div class="form-row">
            <div class="form-group col-md-6">
              <label for="rejectedOrderPrecentage"
                >Rejected Order Percentage (%)
                <span class="required">*</span></label
              >
              <input
                type="number"
                id="rejectedOrderPrecentage"
                formControlName="rejectedOrderPrecentage"
                class="form-control"
                placeholder="0"
                min="0"
                max="100"
                [class.is-invalid]="
                  merchantForm.get('rejectedOrderPrecentage')?.invalid &&
                  merchantForm.get('rejectedOrderPrecentage')?.touched
                "
              />
              @if (merchantForm.get('rejectedOrderPrecentage')?.invalid &&
              merchantForm.get('rejectedOrderPrecentage')?.touched) {
              <div class="invalid-feedback">
                @if
                (merchantForm.get('rejectedOrderPrecentage')?.errors?.['required'])
                {
                <span>Percentage is required</span>
                } @if
                (merchantForm.get('rejectedOrderPrecentage')?.errors?.['min'] ||
                merchantForm.get('rejectedOrderPrecentage')?.errors?.['max']) {
                <span>Must be between 0 and 100</span>
                }
              </div>
              }
            </div>

            <div class="form-group col-md-6">
              <label for="specialPickUp"
                >Special Pickup Fee ($) <span class="required">*</span></label
              >
              <input
                type="number"
                id="specialPickUp"
                formControlName="specialPickUp"
                class="form-control"
                placeholder="0"
                min="0"
                [class.is-invalid]="
                  merchantForm.get('specialPickUp')?.invalid &&
                  merchantForm.get('specialPickUp')?.touched
                "
              />
              @if (merchantForm.get('specialPickUp')?.invalid &&
              merchantForm.get('specialPickUp')?.touched) {
              <div class="invalid-feedback">
                @if (merchantForm.get('specialPickUp')?.errors?.['required']) {
                <span>Special pickup fee is required</span>
                } @if (merchantForm.get('specialPickUp')?.errors?.['min']) {
                <span>Must be 0 or greater</span>
                }
              </div>
              }
            </div>
          </div>

          <div class="form-group">
            <label for="branchesIds"
              >Branches <span class="required">*</span></label
            >
            <div
              class="select-wrapper"
              [class.is-invalid]="
                merchantForm.get('branchesIds')?.invalid &&
                merchantForm.get('branchesIds')?.touched
              "
            >
              <select
                id="branchesIds"
                formControlName="branchesIds"
                class="form-control"
                multiple
                [disabled]="isLoadingBranches() || Branches().length === 0"
              >
                @if (isLoadingBranches()) {
                <option value="" disabled>Loading Branches...</option>
                } @else if (Branches().length === 0) {
                <option value="" disabled>No Branches available</option>
                } @else { @for (branch of Branches(); track branch.id) {
                <option [value]="branch.id">{{ branch.name }}</option>
                } }
              </select>
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </div>
            @if (merchantForm.get('branchesIds')?.invalid &&
            merchantForm.get('branchesIds')?.touched) {
            <div class="invalid-feedback">At least one Branch is required</div>
            }
          </div>

          <div class="form-group">
            <label>Special Delivery Prices</label>
            <div class="special-prices">
              @for (price of specialDeliveryPrices.controls; track $index) {
              <div class="special-price-row" [formGroup]="price">
                <div class="form-row">
                  <div class="form-group col-md-6">
                    <div
                      class="select-wrapper"
                      [class.is-invalid]="
                        price.get('cityId')?.invalid &&
                        price.get('cityId')?.touched
                      "
                    >
                      <select
                        formControlName="cityId"
                        class="form-control"
                        [disabled]="isLoadingCities() || Cities().length === 0"
                      >
                        <option value="">Select City</option>
                        @if (isLoadingCities()) {
                        <option value="" disabled>Loading Cities...</option>
                        } @else if (Cities().length === 0) {
                        <option value="" disabled>No Cities available</option>
                        } @else { @for (city of Cities(); track city.id) {
                        <option [value]="city.id">{{ city.name }}</option>
                        } }
                      </select>
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      >
                        <polyline points="6 9 12 15 18 9"></polyline>
                      </svg>
                    </div>
                    @if (price.get('cityId')?.invalid &&
                    price.get('cityId')?.touched) {
                    <div class="invalid-feedback">City is required</div>
                    }
                  </div>
                  <div class="form-group col-md-4">
                    <input
                      type="number"
                      formControlName="specialPreice"
                      class="form-control"
                      placeholder="0"
                      min="0"
                      [class.is-invalid]="
                        price.get('specialPreice')?.invalid &&
                        price.get('specialPreice')?.touched
                      "
                    />
                    @if (price.get('specialPreice')?.invalid &&
                    price.get('specialPreice')?.touched) {
                    <div class="invalid-feedback">
                      @if (price.get('specialPreice')?.errors?.['required']) {
                      <span>Price is required</span>
                      } @if (price.get('specialPreice')?.errors?.['min']) {
                      <span>Must be 0 or greater</span>
                      }
                    </div>
                    }
                  </div>
                  <div class="form-group col-md-2">
                    <button
                      type="button"
                      class="btn btn-icon btn-danger"
                      (click)="removeSpecialDeliveryPrice($index)"
                      [disabled]="specialDeliveryPrices.length === 1"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      >
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
              }
              <button
                type="button"
                class="btn btn-outline"
                (click)="addSpecialDeliveryPrice()"
                [disabled]="isLoadingCities() || Cities().length === 0"
              >
                Add Special Delivery Price
              </button>
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-outline" (click)="cancel()">
              Cancel
            </button>
            <button type="submit" class="btn btn-primary">
              <!-- [disabled]="merchantForm.invalid || isLoading() || isLoadingBranches() || isLoadingCities()" -->
              @if (isEditing()) { Update } @else { Create }
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  @if (isLoading()) {
  <div class="loading">
    <mat-spinner diameter="40"></mat-spinner>
  </div>
  }
</div>
